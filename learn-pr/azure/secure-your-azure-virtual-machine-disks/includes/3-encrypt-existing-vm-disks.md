<span data-ttu-id="852b2-101">Si supponga che l'azienda abbia deciso di implementare Crittografia dischi di Azure in tutte le macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="852b2-101">Suppose your company has decided to implement Azure Disk Encryption (ADE) across all VMs.</span></span> <span data-ttu-id="852b2-102">È necessario valutare come implementare la crittografia nei volumi delle macchine virtuali esistenti.</span><span class="sxs-lookup"><span data-stu-id="852b2-102">You need to evaluate how to roll out encryption to existing VM volumes.</span></span>

<span data-ttu-id="852b2-103">In questo modulo si esamineranno i requisiti per Crittografia dischi di Azure e i passaggi necessari per la crittografia dei dischi nelle macchine virtuali Windows esistenti.</span><span class="sxs-lookup"><span data-stu-id="852b2-103">Here, we'll look at the requirements for ADE, and the steps involved in encrypting disks on existing Windows VMs.</span></span>

## <a name="azure-disk-encryption-prerequisites"></a><span data-ttu-id="852b2-104">Prerequisiti di Crittografia dischi di Azure</span><span class="sxs-lookup"><span data-stu-id="852b2-104">Azure Disk Encryption Prerequisites</span></span>

<span data-ttu-id="852b2-105">Per poter crittografare il primo disco di una macchina virtuale, è necessario</span><span class="sxs-lookup"><span data-stu-id="852b2-105">Before you can encrypt your first VM disk, you need to</span></span>

1. <span data-ttu-id="852b2-106">Creare un insieme di credenziali delle chiavi</span><span class="sxs-lookup"><span data-stu-id="852b2-106">Create a key vault</span></span>
1. <span data-ttu-id="852b2-107">Configurare un'applicazione Azure AD e un'entità servizio</span><span class="sxs-lookup"><span data-stu-id="852b2-107">Set up an Azure AD application and service principal</span></span>
1. <span data-ttu-id="852b2-108">Impostare i criteri di accesso per l'insieme di credenziali delle chiavi per l'app Azure AD</span><span class="sxs-lookup"><span data-stu-id="852b2-108">Set the key vault access policy for the Azure AD app</span></span>
1. <span data-ttu-id="852b2-109">Impostare i criteri di accesso avanzati per l'insieme di credenziali delle chiavi</span><span class="sxs-lookup"><span data-stu-id="852b2-109">Set key vault advanced access policies</span></span>

### <a name="azure-key-vault"></a><span data-ttu-id="852b2-110">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="852b2-110">Azure Key Vault</span></span>

<span data-ttu-id="852b2-111">Le chiavi di crittografia usate da Crittografia dischi di Azure possono essere archiviate in Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="852b2-111">The encryption keys used by ADE can be stored in an Azure Key Vault.</span></span> <span data-ttu-id="852b2-112">Azure Key Vault è uno strumento che consente di archiviare i segreti e accedervi in modo sicuro.</span><span class="sxs-lookup"><span data-stu-id="852b2-112">Azure Key Vault is a tool for securely storing and accessing secrets.</span></span> <span data-ttu-id="852b2-113">Un segreto è qualsiasi elemento per cui si vuole controllare rigorosamente l'accesso, ad esempio chiavi API, password o certificati.</span><span class="sxs-lookup"><span data-stu-id="852b2-113">A secret is anything that you want to tightly control access to, such as API keys, passwords, or certificates.</span></span> <span data-ttu-id="852b2-114">Questa soluzione fornisce archiviazione sicura, scalabile e a disponibilità elevata in moduli di protezione hardware conformi a FIPS (Federal Information Processing Standards) 140-2, livello 2.</span><span class="sxs-lookup"><span data-stu-id="852b2-114">This provides highly available and scalable secure storage in Federal Information Processing Standards (FIPS) 140-2 Level 2 validated Hardware Security Modules (HSMs).</span></span> <span data-ttu-id="852b2-115">Tramite Key Vault, è possibile avere il controllo completo delle chiavi usate per crittografare i dati ed è possibile gestire e controllare l'utilizzo delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="852b2-115">Using Key Vault, you keep full control of the keys used to encrypt your data, and you can manage and audit your key usage.</span></span> <span data-ttu-id="852b2-116">È possibile configurare e gestire un insieme di credenziali delle chiavi usando il portale di Azure, Azure PowerShell e l'interfaccia della riga di comando di Azure.</span><span class="sxs-lookup"><span data-stu-id="852b2-116">You can configure and manage your key vault using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

>[!NOTE]
> <span data-ttu-id="852b2-117">Crittografia dischi di Azure richiede che l'istanza di Key Vault e le macchine virtuali si trovino nella stessa area di Azure, in modo che i segreti di crittografia non debbano attraversare limiti a livello di area.</span><span class="sxs-lookup"><span data-stu-id="852b2-117">Azure Disk Encryption requires that your Key Vault and your VMs are in the same Azure region; this ensures that encryption secrets do not cross regional boundaries.</span></span>

### <a name="azure-ad-application-and-service-principal"></a><span data-ttu-id="852b2-118">Applicazione Azure AD ed entità servizio</span><span class="sxs-lookup"><span data-stu-id="852b2-118">Azure AD application and service principal</span></span>

<span data-ttu-id="852b2-119">Per accedere alle risorse o modificarle, ad esempio per la configurazione della crittografia per una macchina virtuale con script o codice, è prima necessario configurare un'**applicazione Azure Active Directory (AD)**.</span><span class="sxs-lookup"><span data-stu-id="852b2-119">To access or modify resources, such as the encryption configuration for a VM with scripts or code, you must first set up an **Azure Active Directory (AD) application**.</span></span> <span data-ttu-id="852b2-120">Azure Active Directory (Azure AD) è un servizio di gestione delle identità e directory basato sul cloud multi-tenant, che combina i principali servizi directory, la gestione dell'accesso alle applicazioni e la protezione delle identità in un'unica soluzione.</span><span class="sxs-lookup"><span data-stu-id="852b2-120">Azure Active Directory (Azure AD) is a multi-tenant, cloud-based directory, and identity management service that combines core directory services, application access management, and identity protection into a single solution.</span></span>

<span data-ttu-id="852b2-121">È necessaria anche un'**entità servizio** di Azure.</span><span class="sxs-lookup"><span data-stu-id="852b2-121">You'll also need an Azure **service principal**.</span></span> <span data-ttu-id="852b2-122">Le entità servizio sono gli account del servizio usati per eseguire lo script o il codice e consentono di assegnare le autorizzazioni specifiche e l'ambito necessari per eseguire l'attività su una risorsa di Azure specifica.</span><span class="sxs-lookup"><span data-stu-id="852b2-122">Service principals are the service accounts you use to run the script or code, and allow you to assign the specific permissions and scope that are needed to run the task against a particular Azure resource.</span></span>

<span data-ttu-id="852b2-123">Ci sono due elementi in Azure AD: l'oggetto applicazione è la **_definizione_** dell'applicazione (la sua funzione) e l'entità servizio è l'**_istanza specifica_** dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="852b2-123">There are two elements in Azure AD; the application object is the **_definition_** of the application (what it does), and the service principal is the **_specific instance_** of the application.</span></span>

<span data-ttu-id="852b2-124">Questo approccio è in linea con il principio dei **privilegi minimi**, in base a cui le autorizzazioni assegnate all'app sono limitate al minimo richiesto per consentire all'app di svolgere le attività previste.</span><span class="sxs-lookup"><span data-stu-id="852b2-124">This approach aligns with the principle of **least privilege**, where the permissions assigned to the app are restricted to the bare minimum required to enable the app to perform its tasks.</span></span>

<span data-ttu-id="852b2-125">È possibile configurare e gestire entità servizio e applicazioni Azure AD usando il portale di Azure, Azure PowerShell e l'interfaccia della riga di comando di Azure.</span><span class="sxs-lookup"><span data-stu-id="852b2-125">You can configure and manage Azure AD applications and service principals using the Azure portal, Azure PowerShell, and Azure CLI.</span></span>

### <a name="key-vault-access-policies"></a><span data-ttu-id="852b2-126">Criteri di accesso per gli insiemi di credenziali delle chiavi</span><span class="sxs-lookup"><span data-stu-id="852b2-126">Key vault access policies</span></span>

<span data-ttu-id="852b2-127">Per poter archiviare le chiavi di crittografia in un'istanza di Key Vault, Crittografia dischi di Azure richiede le informazioni relative a **ID client** e **Segreto client** dell'applicazione Azure Active Directory che ha le autorizzazioni per scrivere in Key Vault.</span><span class="sxs-lookup"><span data-stu-id="852b2-127">Before you can store encryption keys in a Key Vault, ADE requires details on the **Client ID** and the **Client Secret** of the Azure Active Directory application that is permitted to write to the Key Vault.</span></span>

<span data-ttu-id="852b2-128">È anche necessario fornire ad Azure l'accesso alle chiavi di crittografia nell'insieme di credenziali delle chiavi, in modo che vengano rese disponibili alla macchina virtuale per l'avvio e la decrittografia dei volumi.</span><span class="sxs-lookup"><span data-stu-id="852b2-128">You'll also need to provide Azure access to the encryption keys in your key vault, so they are made available to the VM for booting and decrypting the volumes.</span></span>

## <a name="set-key-vault-advanced-access-policies"></a><span data-ttu-id="852b2-129">Impostare i criteri di accesso avanzati per l'insieme di credenziali delle chiavi</span><span class="sxs-lookup"><span data-stu-id="852b2-129">Set key vault advanced access policies</span></span>

<span data-ttu-id="852b2-130">I **criteri di accesso avanzati** consentono la crittografia dei dischi nell'insieme di credenziali delle chiavi e in loro assenza le distribuzioni della crittografia hanno esito negativo.</span><span class="sxs-lookup"><span data-stu-id="852b2-130">**Advanced access policies** enable disk encryption on the key vault, and without them, encryption deployments will fail.</span></span> 

<span data-ttu-id="852b2-131">Ci sono tre criteri che devono essere abilitati:</span><span class="sxs-lookup"><span data-stu-id="852b2-131">There are three policies that need to be enabled:</span></span>

- <span data-ttu-id="852b2-132">**Key Vault per la crittografia dei dischi** Obbligatorio per Crittografia dischi di Azure.</span><span class="sxs-lookup"><span data-stu-id="852b2-132">**Key Vault for disk encryption** Required for Azure Disk encryption.</span></span>
- <span data-ttu-id="852b2-133">**Key Vault per la distribuzione** Per consentire al provider di risorse Microsoft.Compute di recuperare i segreti dall'insieme di credenziali delle chiavi. Questo criterio è necessario quando si crea una macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="852b2-133">**Key Vault for deployment** Enables the Microsoft.Compute resource provider to retrieve secrets from the key vault; this policy is needed when creating a VM.</span></span>
- <span data-ttu-id="852b2-134">**Key Vault per la distribuzione di modelli, se necessario** Per consentire ad Azure Resource Manager di recuperare i segreti dall'insieme di credenziali delle chiavi. Questo criterio è necessario quando si usano modelli ARM per la distribuzione delle macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="852b2-134">**Key Vault for template deployment, if needed** Enables Azure Resource Manager to get secrets from the key vault; this policy is required when using ARM templates for VM deployment.</span></span>

<span data-ttu-id="852b2-135">I criteri di accesso dell'insieme di credenziali delle chiavi possono essere configurati e gestiti usando il portale di Azure, Azure PowerShell o l'interfaccia della riga di comando di Azure.</span><span class="sxs-lookup"><span data-stu-id="852b2-135">Key vault access policies can be configured and managed using the Azure portal, Azure PowerShell, or the Azure CLI.</span></span>

### <a name="what-is-the-azure-disk-encryption-prerequisites-configuration-script"></a><span data-ttu-id="852b2-136">Informazioni sullo script di configurazione dei prerequisiti di Crittografia dischi di Azure</span><span class="sxs-lookup"><span data-stu-id="852b2-136">What is the Azure Disk Encryption Prerequisites Configuration Script</span></span>

<span data-ttu-id="852b2-137">Lo **script di configurazione dei prerequisiti di Crittografia dischi di Azure** consente di configurare tutti i prerequisiti di crittografia (o quelli desiderati).</span><span class="sxs-lookup"><span data-stu-id="852b2-137">The **Azure Disk Encryption Prerequisites Configuration Script** sets up all (or as many as you want) of the encryption prerequisites.</span></span> <span data-ttu-id="852b2-138">Lo script assicura anche che Key Vault si trovi nella stessa area della macchina virtuale da crittografare.</span><span class="sxs-lookup"><span data-stu-id="852b2-138">The script also ensures that your Key Vault is in the same region as the VM you are going to encrypt.</span></span> <span data-ttu-id="852b2-139">Lo script crea un gruppo di risorse e un insieme di credenziali delle chiavi e imposta i criteri di accesso dell'insieme di credenziali delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="852b2-139">It will create a resource group, a key vault, and set the key vault access policy.</span></span> <span data-ttu-id="852b2-140">Lo script crea anche un blocco delle risorse nell'insieme di credenziali delle chiavi per la protezione da eliminazioni accidentali.</span><span class="sxs-lookup"><span data-stu-id="852b2-140">The script also creates a resource lock on the key vault to help protect it from accidental deletion.</span></span>

## <a name="encrypting-an-existing-vm-disk"></a><span data-ttu-id="852b2-141">Crittografia di un disco di una macchina virtuale esistente</span><span class="sxs-lookup"><span data-stu-id="852b2-141">Encrypting an existing VM disk</span></span>

<span data-ttu-id="852b2-142">Per la crittografia di un disco di una macchina virtuale esistente usando lo **script di configurazione dei prerequisiti di Crittografia dischi di Azure** sono necessari due passaggi:</span><span class="sxs-lookup"><span data-stu-id="852b2-142">There are two steps for encrypting an existing VM disk, when using the **Azure Disk Encryption Prerequisites Configuration Script**:</span></span>

1. <span data-ttu-id="852b2-143">Eseguire lo script di configurazione dei prerequisiti di Crittografia dischi di Azure.</span><span class="sxs-lookup"><span data-stu-id="852b2-143">Run the Azure disk encryption prerequisites configuration script.</span></span>
1. <span data-ttu-id="852b2-144">Crittografare la macchina virtuale di Azure in PowerShell</span><span class="sxs-lookup"><span data-stu-id="852b2-144">Encrypt the Azure virtual machine in PowerShell</span></span>
