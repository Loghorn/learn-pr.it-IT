<span data-ttu-id="c999d-101">Abbiamo installato software personalizzato, configurato un server FTP e configurato la macchina virtuale per la ricezione di file video.</span><span class="sxs-lookup"><span data-stu-id="c999d-101">We've installed our custom software, set up an FTP server, and configured the VM to receive our video files.</span></span> <span data-ttu-id="c999d-102">Tuttavia, se si prova a connettersi all'indirizzo IP pubblico con il protocollo FTP, si scoprirà che è bloccato.</span><span class="sxs-lookup"><span data-stu-id="c999d-102">However, if we try to connect to our public IP address with FTP, we'll find that it's blocked.</span></span> 

<span data-ttu-id="c999d-103">Apportare modifiche alla configurazione del server è un'operazione eseguita comunemente con dispositivi nell'ambiente locale.</span><span class="sxs-lookup"><span data-stu-id="c999d-103">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="c999d-104">In questo senso, è possibile considerare le macchine virtuali di Azure un'estensione di tale ambiente.</span><span class="sxs-lookup"><span data-stu-id="c999d-104">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="c999d-105">È possibile modificare la configurazione, gestire le reti, aprire o bloccare il traffico e così via, tramite il portale di Azure, l'interfaccia della riga di comando di Azure o strumenti di Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c999d-105">You can make configuration changes, manage networks, open or block traffic, and more through the Azure portal, Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="c999d-106">Abbiamo già visto alcune delle informazioni base e opzioni di gestione nel pannello **Panoramica** della macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="c999d-106">You've already seen some of the basic information and management options in the **Overview** panel for the virtual machine.</span></span> <span data-ttu-id="c999d-107">Ora si approfondirà la configurazione di rete.</span><span class="sxs-lookup"><span data-stu-id="c999d-107">Let's explore network configuration a bit more.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="c999d-108">Apertura delle porte nelle macchine virtuali di Azure</span><span class="sxs-lookup"><span data-stu-id="c999d-108">Opening ports in Azure VMs</span></span>

<!-- TODO: Azure portal is inconsistent here in applying the NSG.
By default, new VMs are locked down. 

Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g. other resources on the same local network), and from Azure's Load Balancer (probe checks). -->

<span data-ttu-id="c999d-109">Esistono due passaggi per modificare la configurazione per supportare FTP.</span><span class="sxs-lookup"><span data-stu-id="c999d-109">There are two steps to adjusting the configuration to support FTP.</span></span> <span data-ttu-id="c999d-110">Quando si crea una nuova macchina virtuale, è possibile aprire alcune porte comuni (RDP, HTTP, HTTPS e SSH).</span><span class="sxs-lookup"><span data-stu-id="c999d-110">When you create a new VM you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="c999d-111">Tuttavia, se sono necessarie altre modifiche al firewall, sarà necessario intervenire personalmente.</span><span class="sxs-lookup"><span data-stu-id="c999d-111">However, if you require other changes to the firewall, you will need to do them yourself.</span></span>

<span data-ttu-id="c999d-112">La procedura prevede due passaggi:</span><span class="sxs-lookup"><span data-stu-id="c999d-112">The process for this involves two steps:</span></span>

1. <span data-ttu-id="c999d-113">Creare un gruppo di sicurezza di rete.</span><span class="sxs-lookup"><span data-stu-id="c999d-113">Create a Network Security Group.</span></span>
2. <span data-ttu-id="c999d-114">Creare una regola in ingresso che consenta il transito del traffico sulle porte 20 e 21 per il supporto FTP attivo.</span><span class="sxs-lookup"><span data-stu-id="c999d-114">Create an inbound rule allowing traffic on port 20 and 21 for active FTP support.</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="c999d-115">Che cos'è un gruppo di sicurezza di rete?</span><span class="sxs-lookup"><span data-stu-id="c999d-115">What is a Network Security Group?</span></span>

<span data-ttu-id="c999d-116">Le reti virtuali sono alla base del modello di rete di Azure e offrono isolamento e protezione.</span><span class="sxs-lookup"><span data-stu-id="c999d-116">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="c999d-117">I gruppi di sicurezza di rete (NSG) sono lo strumento principale che consente di applicare e controllare le regole del traffico di rete a livello di rete.</span><span class="sxs-lookup"><span data-stu-id="c999d-117">Network Security Groups (NSGs) are the main tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="c999d-118">I gruppi di sicurezza di rete sono un livello di sicurezza facoltativo che fornisce un firewall software mediante il filtraggio del traffico in ingresso e in uscita sulla rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="c999d-118">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="c999d-119">I gruppi di sicurezza possono essere associati a un'interfaccia di rete (per le regole per ogni host), a una subnet nella rete virtuale (per l'applicazione a più risorse) o a entrambi i livelli.</span><span class="sxs-lookup"><span data-stu-id="c999d-119">Security groups can be associated to a network interface (for per-host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="c999d-120">Regole dei gruppi di sicurezza</span><span class="sxs-lookup"><span data-stu-id="c999d-120">Security group rules</span></span>

<span data-ttu-id="c999d-121">I gruppi di sicurezza di rete usano _regole_ per consentire o negare il transito del traffico nella rete.</span><span class="sxs-lookup"><span data-stu-id="c999d-121">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="c999d-122">Ogni regola identifica l'indirizzo di origine e destinazione (o un intervallo), il protocollo, la porta (o intervallo di porte), la direzione (in ingresso o in uscita), una priorità numerica e se consentire o negare il traffico che corrisponde alla regola.</span><span class="sxs-lookup"><span data-stu-id="c999d-122">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span>

![Regole dei gruppi di sicurezza di rete](../media/7-nsg-rules.png)

<span data-ttu-id="c999d-124">Ogni gruppo di sicurezza ha un set di regole di sicurezza predefinite per applicare le regole di rete predefinite descritte in precedenza.</span><span class="sxs-lookup"><span data-stu-id="c999d-124">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="c999d-125">Queste regole predefinite non possono essere modificate, ma _possono_ essere sottoposto a override.</span><span class="sxs-lookup"><span data-stu-id="c999d-125">These default rules cannot be modified, but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="c999d-126">Come vengono usate le regole di rete in Azure</span><span class="sxs-lookup"><span data-stu-id="c999d-126">How Azure uses network rules</span></span>

<span data-ttu-id="c999d-127">Per il traffico in ingresso, Azure elabora il gruppo di sicurezza associato alla subnet e quindi il gruppo di sicurezza applicato all'interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="c999d-127">For inbound traffic, Azure processes the security group associated to the subnet, then the security group applied to the network interface.</span></span> <span data-ttu-id="c999d-128">Il traffico in uscita viene elaborato nell'ordine inverso, vale a dire prima l'interfaccia di rete seguita dalla subnet.</span><span class="sxs-lookup"><span data-stu-id="c999d-128">Outbound traffic is processed in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]
> <span data-ttu-id="c999d-129">Tenere presente che i gruppi di sicurezza sono facoltativi a entrambi i livelli.</span><span class="sxs-lookup"><span data-stu-id="c999d-129">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="c999d-130">Se non viene applicato alcun gruppo di sicurezza, **tutto il traffico è consentito** da Azure.</span><span class="sxs-lookup"><span data-stu-id="c999d-130">If no security group is applied then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="c999d-131">Se la macchina virtuale ha un indirizzo IP pubblico, questo potrebbe essere un grave rischio in particolare se il sistema operativo non include un qualche tipo di firewall.</span><span class="sxs-lookup"><span data-stu-id="c999d-131">If the VM has a public IP, this could be a serious risk particularly if the OS doesn't provide some sort of firewall.</span></span>

<span data-ttu-id="c999d-132">Le regole vengono valutate nell'_ordine di priorità_, a partire dalla regola con la **priorità più bassa**.</span><span class="sxs-lookup"><span data-stu-id="c999d-132">The rules are evaluated in _priority-order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="c999d-133">Le regole di negazione **arrestano** sempre la valutazione.</span><span class="sxs-lookup"><span data-stu-id="c999d-133">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="c999d-134">Ad esempio, se una richiesta in uscita viene bloccata da regola di interfaccia di rete, tutte le regole applicate alla subnet non verranno controllate.</span><span class="sxs-lookup"><span data-stu-id="c999d-134">For example, if an outbound request is blocked by a network interface rule, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="c999d-135">Affinché possa attraversare il gruppo di sicurezza, il traffico deve passare attraverso _tutti_ i gruppi applicati.</span><span class="sxs-lookup"><span data-stu-id="c999d-135">In order for traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="c999d-136">L'ultima regola è sempre una regola **Nega tutto**.</span><span class="sxs-lookup"><span data-stu-id="c999d-136">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="c999d-137">Si tratta di una regola predefinita aggiunta a ogni gruppo di sicurezza per il traffico in ingresso e in uscita con una priorità di 65500.</span><span class="sxs-lookup"><span data-stu-id="c999d-137">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="c999d-138">Questo significa che affinché il traffico possa passare attraverso il gruppo di sicurezza _è necessario avere una regola per consentirlo_, in assenza della quale verrà bloccato dalla regola finale.</span><span class="sxs-lookup"><span data-stu-id="c999d-138">That means to have traffic pass through the security group _you must have an allow rule_ or it will be blocked by the default final rule.</span></span>

> [!NOTE]
> <span data-ttu-id="c999d-139">SMTP (porta 25) è un caso speciale. A seconda del livello di sottoscrizione e di quando è stato creato l'account, il traffico SMTP in uscita potrebbe essere bloccato.</span><span class="sxs-lookup"><span data-stu-id="c999d-139">SMTP (port 25) is a special case, depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="c999d-140">È possibile richiedere di rimuovere questa restrizione con una giustificazione aziendale.</span><span class="sxs-lookup"><span data-stu-id="c999d-140">You can make a request to remove this restriction with business justification.</span></span>

<span data-ttu-id="c999d-141">Dato che non è stato creato un gruppo di sicurezza per questa macchina virtuale, è possibile farlo e applicarlo.</span><span class="sxs-lookup"><span data-stu-id="c999d-141">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="c999d-142">Creazione di gruppi di sicurezza di rete</span><span class="sxs-lookup"><span data-stu-id="c999d-142">Creating Network Security Groups</span></span>

<span data-ttu-id="c999d-143">I gruppi di sicurezza sono risorse gestite, come la maggior parte degli elementi in Azure. È possibile crearli nel portale di Azure o tramite gli strumenti di scripting da riga di comando.</span><span class="sxs-lookup"><span data-stu-id="c999d-143">Security groups are managed resources like most everything in Azure, you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="c999d-144">L'aspetto più complicato è la definizione delle regole.</span><span class="sxs-lookup"><span data-stu-id="c999d-144">The challenge is in defining the rules.</span></span> <span data-ttu-id="c999d-145">Vediamo come definire una nuova regola per consentire l'accesso FTP.</span><span class="sxs-lookup"><span data-stu-id="c999d-145">Let's look at defining a new rule to allow FTP access.</span></span>