<span data-ttu-id="8441b-101">Ora si aggiornerà l'implementazione della funzione per chiamare il servizio API Analisi del testo e ottenere un punteggio del sentiment.</span><span class="sxs-lookup"><span data-stu-id="8441b-101">Let's update our function implementation to call the Text Analytics API service and get back a sentiment score.</span></span>

1. <span data-ttu-id="8441b-102">Selezionare la funzione [!INCLUDE [func-name-discover](./func-name-discover.md)] nell'app per le funzioni all'interno del portale.</span><span class="sxs-lookup"><span data-stu-id="8441b-102">Select our function, [!INCLUDE [func-name-discover](./func-name-discover.md)], in our function app in the portal.</span></span>

1. <span data-ttu-id="8441b-103">Espandere il menu **Visualizza file** sul lato destro della schermata.</span><span class="sxs-lookup"><span data-stu-id="8441b-103">Expand the **View files** menu on the right of the screen.</span></span>

1. <span data-ttu-id="8441b-104">Nella scheda **Visualizza file** selezionare **index.js** per aprire il file di codice nell'editor.</span><span class="sxs-lookup"><span data-stu-id="8441b-104">Under the **View files** tab, select **index.js** to open the code file in the editor.</span></span>

1. <span data-ttu-id="8441b-105">Sostituire l'intero contenuto del file **index.js** con il codice JavaScript seguente e fare clic su **Salva**.</span><span class="sxs-lookup"><span data-stu-id="8441b-105">Replace the entire content of **index.js** with the following JavaScript and **Save**.</span></span>

    [!code-javascript[](../code/discover-sentiment-sort.js?highlight=7)]

1. <span data-ttu-id="8441b-106">Aggiornare il valore di `accessKey` nel codice incollato con la chiave di accesso per l'API Analisi del testo salvata in precedenza in questo modulo.</span><span class="sxs-lookup"><span data-stu-id="8441b-106">Update the value of `accessKey` in the code you pasted with the access key for the Text Analytics API that you saved earlier in this module.</span></span> 

1. <span data-ttu-id="8441b-107">Aggiornare il valore `uri` con l'area da cui è stata ottenuta la chiave di accesso.</span><span class="sxs-lookup"><span data-stu-id="8441b-107">Update the `uri` value with the region from which you obtained your access key.</span></span>

<span data-ttu-id="8441b-108">Osservare cosa avviene nel codice:</span><span class="sxs-lookup"><span data-stu-id="8441b-108">Let's look at what's happening in this code:</span></span>

- <span data-ttu-id="8441b-109">Ogni chiamata al servizio Analisi del testo richiede la chiave di accesso, che viene aggiunta come intestazione `Ocp-Apim-Subscription-Key`.</span><span class="sxs-lookup"><span data-stu-id="8441b-109">Each call to the Text Analytics service, needs the access key, which we add as the `Ocp-Apim-Subscription-Key` header.</span></span> 
- <span data-ttu-id="8441b-110">Ogni chiamata viene effettuata a un endpoint specifico dell'area geografica, definito da `uri` nel nostro codice.</span><span class="sxs-lookup"><span data-stu-id="8441b-110">Each call is made to a region-specific endpoint, defined by `uri` in our code.</span></span>
- <span data-ttu-id="8441b-111">Alla fine del file di codice è stata definita una matrice `documents`.</span><span class="sxs-lookup"><span data-stu-id="8441b-111">At the bottom of the code file, we've defined a `documents` array.</span></span> <span data-ttu-id="8441b-112">Questa matrice è il payload che viene inviato al servizio Analisi del testo.</span><span class="sxs-lookup"><span data-stu-id="8441b-112">This array is the payload we send to the Text Analytics service.</span></span>
- <span data-ttu-id="8441b-113">La matrice `documents` dispone di una singola entità in questo caso, ovvero il messaggio della coda che ha attivato la funzione.</span><span class="sxs-lookup"><span data-stu-id="8441b-113">The `documents` array has a single entry in this case, which is the queue message that triggered our function.</span></span> <span data-ttu-id="8441b-114">Anche se si ha solo un documento nella matrice, questo non significa che la soluzione sia in grado di gestire solo uno messaggio alla volta.</span><span class="sxs-lookup"><span data-stu-id="8441b-114">Although we only have one document in our array, it doesn't mean that our solution can only handle one message at a time.</span></span> <span data-ttu-id="8441b-115">Il runtime di Funzioni di Azure recupera ed elabora i messaggi in batch, chiamando diverse istanze della funzione *in parallelo*.</span><span class="sxs-lookup"><span data-stu-id="8441b-115">The Azure Functions runtime retrieves and processes messages in batches, calling several instances of our function *in parallel*.</span></span> <span data-ttu-id="8441b-116">Attualmente, le dimensioni predefinite del batch sono pari a 16, mentre quelle massime sono di 32.</span><span class="sxs-lookup"><span data-stu-id="8441b-116">Currently, the default batch size is 16 and the maximum batch size is 32.</span></span>
- <span data-ttu-id="8441b-117">`id` deve essere univoco nella matrice.</span><span class="sxs-lookup"><span data-stu-id="8441b-117">The `id` must be unique within the array.</span></span> <span data-ttu-id="8441b-118">La proprietà `language` la lingua del testo del documento.</span><span class="sxs-lookup"><span data-stu-id="8441b-118">The `language` property specifies the language of the document text.</span></span>
- <span data-ttu-id="8441b-119">Viene quindi chiamato il metodo `get_sentiments`, che usa il modulo HTTPS per eseguire la chiamata all'API Analisi del testo.</span><span class="sxs-lookup"><span data-stu-id="8441b-119">We then call our method `get_sentiments`, which uses the HTTPS module to make the call to Text Analytics API.</span></span> <span data-ttu-id="8441b-120">Si noti che nell'intestazione di ogni richiesta viene passata la chiave di sottoscrizione, o chiave di accesso.</span><span class="sxs-lookup"><span data-stu-id="8441b-120">Notice that we pass our subscription, or access, key in the header of every request.</span></span>
- <span data-ttu-id="8441b-121">Al termine del servizio viene chiamato `response_handler` e la risposta viene registrata nella console tramite `context.log`</span><span class="sxs-lookup"><span data-stu-id="8441b-121">When the service returns, our `response_handler` is called, and we log the response to the console using `context.log`</span></span>


## <a name="try-it-out"></a><span data-ttu-id="8441b-122">Provare questa operazione</span><span class="sxs-lookup"><span data-stu-id="8441b-122">Try it out</span></span>

<span data-ttu-id="8441b-123">Prima di esaminare l'ordinamento nelle code, si procederà a un'esecuzione dei test.</span><span class="sxs-lookup"><span data-stu-id="8441b-123">Before we look at sorting into queues, let's take what we have for a test run.</span></span>

1. <span data-ttu-id="8441b-124">Con la funzione [!INCLUDE [func-name-discover](./func-name-discover.md)] selezionata nell'area delle app per le funzioni del portale, fare clic sulla voce di menu **Test** all'estrema destra.</span><span class="sxs-lookup"><span data-stu-id="8441b-124">With our function, [!INCLUDE [func-name-discover](./func-name-discover.md)], selected in the Function Apps area of the portal, click on the **Test** menu item on the far right.</span></span>

1. <span data-ttu-id="8441b-125">Selezionare la voce di menu **Test** e verificare che il pannello Test sia aperto.</span><span class="sxs-lookup"><span data-stu-id="8441b-125">Select the **Test** menu item, and verify that you have the test panel open.</span></span>

1. <span data-ttu-id="8441b-126">Aggiungere una stringa di testo nel corpo della richiesta, come illustrato nello screenshot.</span><span class="sxs-lookup"><span data-stu-id="8441b-126">Add a string of text into the request body as shown in the screenshot.</span></span>

    ![Screenshot che illustra il pannello Test della funzione espanso.](../media/test-panel-open-small.png)

1.  <span data-ttu-id="8441b-128">Fare clic su **Esegui** nella parte inferiore del pannello Test.</span><span class="sxs-lookup"><span data-stu-id="8441b-128">Click **Run** at the bottom of the test panel.</span></span>

1. <span data-ttu-id="8441b-129">Assicurarsi che la scheda **Log** sia espansa nell'angolo in basso a sinistra della schermata principale, in corrispondenza dell'editor di codice.</span><span class="sxs-lookup"><span data-stu-id="8441b-129">Make sure the **Logs** tab is expanded at the bottom left of the main screen, under the code editor.</span></span>

1. <span data-ttu-id="8441b-130">Verificare che la scheda **Log** visualizzi le informazioni dei log che la funzione ha completato.</span><span class="sxs-lookup"><span data-stu-id="8441b-130">Verify that the **Logs** tab displays log information that the function completed.</span></span> <span data-ttu-id="8441b-131">Nella finestra sarà inoltre visualizzata la risposta dalla chiamata all'API Analisi del testo.</span><span class="sxs-lookup"><span data-stu-id="8441b-131">The window will also display the response from the Text Analytics API call.</span></span>

    ![Screenshot che mostra il pannello Test e il risultato di un test con esito positivo.](../media/sentiment-response-log1.png)

<span data-ttu-id="8441b-133">La procedura è stata completata.</span><span class="sxs-lookup"><span data-stu-id="8441b-133">Congratulations!</span></span> <span data-ttu-id="8441b-134">[!INCLUDE [func-name-discover](./func-name-discover.md)] funziona come previsto.</span><span class="sxs-lookup"><span data-stu-id="8441b-134">The [!INCLUDE [func-name-discover](./func-name-discover.md)] works as designed.</span></span> <span data-ttu-id="8441b-135">In questo esempio è stato passato un messaggio molto positivo e si è ottenuto un punteggio di oltre 0,98.</span><span class="sxs-lookup"><span data-stu-id="8441b-135">In this example, we passed in a very upbeat message and received a score of over 0.98.</span></span> <span data-ttu-id="8441b-136">Provare a modificare il messaggio rendendolo meno ottimistico, eseguire nuovamente il test e osservare la risposta.</span><span class="sxs-lookup"><span data-stu-id="8441b-136">Try changing the message to something less optimistic, rerun the test, and note the response.</span></span>

## <a name="add-a-message-to-the-queue"></a><span data-ttu-id="8441b-137">Aggiungere un messaggio alla coda</span><span class="sxs-lookup"><span data-stu-id="8441b-137">Add a message to the queue</span></span>

<span data-ttu-id="8441b-138">Ora ripetere il test.</span><span class="sxs-lookup"><span data-stu-id="8441b-138">Let's repeat the test.</span></span> <span data-ttu-id="8441b-139">Questa volta, invece di usare la finestra Test del portale, si inserirà effettivamente un messaggio nella coda di input e si osserverà cosa accade.</span><span class="sxs-lookup"><span data-stu-id="8441b-139">This time, instead of using the Test window of the portal, we'll actually place a message into the input queue and watch what happens.</span></span>

1. <span data-ttu-id="8441b-140">Passare al gruppo di risorse nella sezione **Gruppi di risorse** del portale.</span><span class="sxs-lookup"><span data-stu-id="8441b-140">Navigate to your resource group in the **Resource Groups** section of the portal.</span></span>

1. <span data-ttu-id="8441b-141">Selezionare <rgn>[Nome del gruppo di risorse sandbox]</rgn>, il gruppo di risorse usato in questa lezione.</span><span class="sxs-lookup"><span data-stu-id="8441b-141">Select <rgn>[sandbox resource group name]</rgn>, the resource group used in this lesson.</span></span>

1. <span data-ttu-id="8441b-142">Nel pannello **Gruppo di risorse** visualizzato individuare la voce Account di archiviazione e selezionarla.</span><span class="sxs-lookup"><span data-stu-id="8441b-142">In the **Resource group** panel that appears, locate the Storage Account entry, and select it.</span></span>

    ![Screenshot dell'account di archiviazione selezionato nella finestra Gruppo di risorse.](../media/select-storage-account.png)

1. <span data-ttu-id="8441b-144">Selezionare **Storage Explorer (anteprima)** dal menu a sinistra della finestra principale di Account di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="8441b-144">Select **Storage Explorer (preview)** from the left menu of the Storage Account main window.</span></span> <span data-ttu-id="8441b-145">Questa azione apre Azure Storage Explorer all'interno del portale.</span><span class="sxs-lookup"><span data-stu-id="8441b-145">This action opens the Azure Storage Explorer inside the portal.</span></span> 

    ![Screenshot di Storage Explorer con l'account di archiviazione, attualmente senza code.](../media/sa-no-queue.png)

    <span data-ttu-id="8441b-147">Come si può notare, in questo account di archiviazione non ci sono ancora code, quindi aggiungerne una.</span><span class="sxs-lookup"><span data-stu-id="8441b-147">As you can see, we don't have any queues in this storage account yet, so let's add one.</span></span>

5. <span data-ttu-id="8441b-148">Più indietro in questa lezione la coda associata al trigger è stata denominata **new-feedback-q**.</span><span class="sxs-lookup"><span data-stu-id="8441b-148">If you remember from earlier in this lesson, we named the queue associated with our trigger **new-feedback-q**.</span></span> <span data-ttu-id="8441b-149">Fare clic con il pulsante destro del mouse sull'elemento **Code** in Storage Explorer e scegliere *Crea coda*.</span><span class="sxs-lookup"><span data-stu-id="8441b-149">Right-click on the **Queues** item in the Storage Explorer, and select *Create Queue*.</span></span>

1. <span data-ttu-id="8441b-150">Nella finestra di dialogo visualizzata immettere **new-feedback-q** e fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="8441b-150">In the dialog that opens, enter **new-feedback-q** and click **OK**.</span></span> <span data-ttu-id="8441b-151">È ora disponibile una coda di input.</span><span class="sxs-lookup"><span data-stu-id="8441b-151">We now have our input queue.</span></span>

1. <span data-ttu-id="8441b-152">Selezionare la nuova coda nel menu a sinistra per visualizzare Esplora dati per questa coda.</span><span class="sxs-lookup"><span data-stu-id="8441b-152">Select the new queue in the left-hand menu to see the data explorer for this queue.</span></span> <span data-ttu-id="8441b-153">Come previsto, la coda è vuota.</span><span class="sxs-lookup"><span data-stu-id="8441b-153">As expected, the queue is empty.</span></span> <span data-ttu-id="8441b-154">Aggiungere un messaggio alla coda usando il comando **Aggiungi messaggio** nella parte superiore della finestra.</span><span class="sxs-lookup"><span data-stu-id="8441b-154">Let's add a message to the queue using the **Add Message** command at the top of the window.</span></span>

1. <span data-ttu-id="8441b-155">Nella finestra di dialogo **Aggiungi messaggio** immettere il messaggio "This message came from our input queue, new-feedback-q" nel campo **Testo del messaggio** e fare clic su **OK** nella parte inferiore della finestra di dialogo.</span><span class="sxs-lookup"><span data-stu-id="8441b-155">In the **Add Message** dialog, enter "This message came from our input queue, new-feedback-q" into the **Message text** field, and click **OK** at the bottom of the dialog.</span></span>

1. <span data-ttu-id="8441b-156">Osservare il messaggio in Esplora dati, simile a quello dello screenshot seguente.</span><span class="sxs-lookup"><span data-stu-id="8441b-156">Observe the message, similar to the message in the following screenshot, in the data explorer.</span></span>
    <span data-ttu-id="8441b-157">![Screenshot di Storage Explorer con l'account di archiviazione e con il messaggio creato nella coda.](../media/message-in-input-queue.png)</span><span class="sxs-lookup"><span data-stu-id="8441b-157">![Screenshot of Storage Explorer showing our storage account, with the message we created in the queue.](../media/message-in-input-queue.png)</span></span>

1. <span data-ttu-id="8441b-158">Dopo alcuni secondi, fare clic su **Aggiorna** per aggiornare la visualizzazione della coda.</span><span class="sxs-lookup"><span data-stu-id="8441b-158">After a few seconds, click **Refresh** to refresh the view of the queue.</span></span> <span data-ttu-id="8441b-159">Si osservi che la coda è ancora una volta **vuota**.</span><span class="sxs-lookup"><span data-stu-id="8441b-159">Observe that the queue is **empty** once again.</span></span> <span data-ttu-id="8441b-160">Il messaggio è stato letto nella coda.</span><span class="sxs-lookup"><span data-stu-id="8441b-160">Something must have read the message from the queue.</span></span>

1. <span data-ttu-id="8441b-161">Tornare alla funzione nel portale e aprire la scheda **Monitoraggio**. Selezionare il messaggio più recente nell'elenco.</span><span class="sxs-lookup"><span data-stu-id="8441b-161">Navigate back to our function in the portal, and open the **Monitor** tab. Select the newest message in the list.</span></span> <span data-ttu-id="8441b-162">Si noti che la funzione ha elaborato il messaggio della coda che era stato inserito in new-feedback-q.</span><span class="sxs-lookup"><span data-stu-id="8441b-162">Observe that our function processed the queue message we had posted to the new-feedback-q.</span></span> <span data-ttu-id="8441b-163">I risultati possono apparire in ritardo in questo log, quindi può essere necessario attendere qualche minuto e premere *Aggiorna*.</span><span class="sxs-lookup"><span data-stu-id="8441b-163">Results may be delayed by in this log, so you might have to wait a few minutes and hit *Refresh*.</span></span>

    ![Screenshot del dashboard di monitoraggio con una voce che indica che la funzione ha elaborato il messaggio della coda inserito in new-feedback-q.](../media/message-in-monitor.png)

    <span data-ttu-id="8441b-165">In questo test è stato eseguito un round trip completo di inserimento di un elemento nella coda e successiva elaborazione da parte della funzione.</span><span class="sxs-lookup"><span data-stu-id="8441b-165">In this test, we did a complete round trip of posting something into our queue and then seeing the function process it.</span></span>

<span data-ttu-id="8441b-166">La soluzione creata è in continua evoluzione</span><span class="sxs-lookup"><span data-stu-id="8441b-166">We're making progress with our solution!</span></span> <span data-ttu-id="8441b-167">e ora la funzione sta eseguendo nuove funzionalità utili.</span><span class="sxs-lookup"><span data-stu-id="8441b-167">Our function is now doing something useful.</span></span> <span data-ttu-id="8441b-168">Riceve testo dalla coda di input e quindi chiama il servizio API Analisi del testo per ottenere un punteggio del sentiment.</span><span class="sxs-lookup"><span data-stu-id="8441b-168">It's receiving text from our input queue and then calling out to the Text Analytics API service to get a sentiment score.</span></span> <span data-ttu-id="8441b-169">Si è inoltre appreso come testare la funzione tramite il portale di Azure e Storage Explorer.</span><span class="sxs-lookup"><span data-stu-id="8441b-169">We've also learned how to test our function through the Azure portal and the Storage Explorer.</span></span> <span data-ttu-id="8441b-170">Nel prossimo esercizio si vedrà come è facile scrivere nelle code tramite le associazioni di output.</span><span class="sxs-lookup"><span data-stu-id="8441b-170">In the next exercise, we'll see how easy it is to write to queues using output bindings.</span></span>