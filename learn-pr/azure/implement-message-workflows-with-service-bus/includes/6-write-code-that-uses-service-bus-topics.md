<span data-ttu-id="4fb95-101">In un'applicazione distribuita alcuni messaggi devono essere inviati a un singolo componente destinatario.</span><span class="sxs-lookup"><span data-stu-id="4fb95-101">In a distributed application, some messages need to be sent to a single recipient component.</span></span> <span data-ttu-id="4fb95-102">Altri messaggi devono raggiungere più di una destinazione.</span><span class="sxs-lookup"><span data-stu-id="4fb95-102">Other messages need to reach more than one destination.</span></span>

<span data-ttu-id="4fb95-103">Si esaminerà ora cosa accade quando un utente annulla un ordine di una pizza.</span><span class="sxs-lookup"><span data-stu-id="4fb95-103">Let's discuss what happens when a user cancels a pizza order.</span></span> <span data-ttu-id="4fb95-104">Si tratta di uno scenario un po' diverso rispetto all'esecuzione dell'ordine iniziale.</span><span class="sxs-lookup"><span data-stu-id="4fb95-104">This is a little different than placing the initial order.</span></span> <span data-ttu-id="4fb95-105">In tal caso, era necessario attendere l'elaborazione del pagamento per inviare l'ordine per i passaggi successivi (ad esempio la preparazione e la cottura nel negozio locale).</span><span class="sxs-lookup"><span data-stu-id="4fb95-105">In that case, we wanted to wait until the order cleared payment processing before sending the order on to other steps (like having it prepared and cooked at the local storefront).</span></span> <span data-ttu-id="4fb95-106">Per l'operazione di annullamento, è invece necessario inviare una notifica sia al negozio locale *sia* al componente di elaborazione dei pagamenti.</span><span class="sxs-lookup"><span data-stu-id="4fb95-106">But for the cancel operation, we are going to notify both the storefront *and* the payment processor at the same time.</span></span> <span data-ttu-id="4fb95-107">Questo approccio riduce al minimo le probabilità di sprecare ingredienti o il tempo dell'autista addetto alla consegna.</span><span class="sxs-lookup"><span data-stu-id="4fb95-107">This approach minimizes the chances that we waste ingredients or delivery driver time.</span></span>

<span data-ttu-id="4fb95-108">Per consentire a più componenti di ricevere lo stesso messaggio, si userà un argomento del bus di servizio di Azure.</span><span class="sxs-lookup"><span data-stu-id="4fb95-108">To allow multiple components to receive the same message, we'll use an Azure Service Bus topic.</span></span>

## <a name="how-code-that-uses-topics-differs-from-queues"></a><span data-ttu-id="4fb95-109">Differenze del codice che usa argomenti rispetto alle code</span><span class="sxs-lookup"><span data-stu-id="4fb95-109">How code that uses topics differs from queues</span></span>

<span data-ttu-id="4fb95-110">Se si vuole che ogni messaggio inviato all'argomento venga recapitato a tutti i componenti che hanno eseguito la sottoscrizione, è necessario usare gli argomenti.</span><span class="sxs-lookup"><span data-stu-id="4fb95-110">If you want every message sent to the topic to be delivered to all subscribing components, you'll use topics.</span></span> <span data-ttu-id="4fb95-111">La scrittura di codice che usa gli argomenti rappresenta un modo per sostituire le code.</span><span class="sxs-lookup"><span data-stu-id="4fb95-111">Writing code that uses topics is a way to replace queues.</span></span> <span data-ttu-id="4fb95-112">Si usa lo stesso pacchetto NuGet **Microsoft.Azure.ServiceBus**, si configurano le stringhe di connessione e si usano modelli di programmazione asincrona.</span><span class="sxs-lookup"><span data-stu-id="4fb95-112">You use the same **Microsoft.Azure.ServiceBus** NuGet package, configure connection strings, and use asynchronous programming patterns.</span></span>

<span data-ttu-id="4fb95-113">Tuttavia, si usa la classe `TopicClient` invece della classe `QueueClient` per inviare i messaggi e la classe `SubscriptionClient` per ricevere i messaggi.</span><span class="sxs-lookup"><span data-stu-id="4fb95-113">However, you use the `TopicClient` class instead of the `QueueClient` class to send messages and the `SubscriptionClient` class to receive messages.</span></span>

## <a name="setting-filters-on-subscriptions"></a><span data-ttu-id="4fb95-114">Impostazione di filtri nelle sottoscrizioni</span><span class="sxs-lookup"><span data-stu-id="4fb95-114">Setting filters on subscriptions</span></span>

<span data-ttu-id="4fb95-115">Se si vuole controllare quali messaggi inviati all'argomento vengono recapitati a sottoscrizioni specifiche, è possibile inserire filtri in ogni sottoscrizione dell'argomento.</span><span class="sxs-lookup"><span data-stu-id="4fb95-115">If you want to control which messages sent to the topic are delivered to which subscriptions, you can place filters on each subscription in the topic.</span></span> <span data-ttu-id="4fb95-116">Nell'applicazione per la pizza, ad esempio, i negozi eseguono applicazioni Universal Windows Platform (UWP).</span><span class="sxs-lookup"><span data-stu-id="4fb95-116">In the pizza application, for instance, our storefronts are running Universal Windows Platform (UWP) applications.</span></span> <span data-ttu-id="4fb95-117">Ogni negozio può sottoscrivere l'argomento "OrderCancellation", ma applicare un filtro per il proprio valore di StoreId.</span><span class="sxs-lookup"><span data-stu-id="4fb95-117">Each store can subscribe to the "OrderCancellation" topic but filter for its own StoreId.</span></span> <span data-ttu-id="4fb95-118">In questo modo, si risparmia larghezza di banda Internet in quanto non vengono inviati messaggi non necessari a negozi distanti.</span><span class="sxs-lookup"><span data-stu-id="4fb95-118">We save internet bandwidth because we are not sending unnecessary messages to distant store locations.</span></span> <span data-ttu-id="4fb95-119">Nel frattempo, il componente di elaborazione dei pagamenti sottoscrive tutti i messaggi di annullamento.</span><span class="sxs-lookup"><span data-stu-id="4fb95-119">Meanwhile, the payment processing component subscribes to all our cancellation messages.</span></span>

<span data-ttu-id="4fb95-120">I filtri possono essere di tre tipi:</span><span class="sxs-lookup"><span data-stu-id="4fb95-120">Filters can be one of three types:</span></span>

- <span data-ttu-id="4fb95-121">**Filtri booleani.**</span><span class="sxs-lookup"><span data-stu-id="4fb95-121">**Boolean Filters.**</span></span> <span data-ttu-id="4fb95-122">`TrueFilter` garantisce che tutti i messaggi inviati all'argomento vengano recapitati alla sottoscrizione corrente.</span><span class="sxs-lookup"><span data-stu-id="4fb95-122">The `TrueFilter` ensures that all messages sent to the topic are delivered to the current subscription.</span></span> <span data-ttu-id="4fb95-123">`FalseFilter` garantisce che nessuno dei messaggi vengano recapitati alla sottoscrizione corrente.</span><span class="sxs-lookup"><span data-stu-id="4fb95-123">The `FalseFilter` ensures that none of the messages are delivered to the current subscription.</span></span> <span data-ttu-id="4fb95-124">(Questa scelta blocca o disattiva a tutti gli effetti la sottoscrizione.)</span><span class="sxs-lookup"><span data-stu-id="4fb95-124">(This effectively blocks or switches off the subscription.)</span></span>
- <span data-ttu-id="4fb95-125">**Filtri SQL.**</span><span class="sxs-lookup"><span data-stu-id="4fb95-125">**SQL Filters.**</span></span> <span data-ttu-id="4fb95-126">Un filtro SQL specifica una condizione usando la stessa sintassi di una clausola `WHERE` in una query SQL.</span><span class="sxs-lookup"><span data-stu-id="4fb95-126">A SQL filter specifies a condition by using the same syntax as a `WHERE` clause in a SQL query.</span></span> <span data-ttu-id="4fb95-127">Solo i messaggi che restituiscono `True` quando valutati rispetto alla sottoscrizione vengono recapitati ai sottoscrittori.</span><span class="sxs-lookup"><span data-stu-id="4fb95-127">Only messages that return `True` when evaluated against this subscription will be delivered to the subscribers.</span></span>
- <span data-ttu-id="4fb95-128">**Filtri di correlazione.**</span><span class="sxs-lookup"><span data-stu-id="4fb95-128">**Correlation Filters.**</span></span> <span data-ttu-id="4fb95-129">Un filtro di correlazione contiene un set di condizioni che vengono confrontate con le proprietà di ogni messaggio.</span><span class="sxs-lookup"><span data-stu-id="4fb95-129">A correlation filter holds a set of conditions that are matched against the properties of each message.</span></span> <span data-ttu-id="4fb95-130">Se la proprietà nel filtro e la proprietà del messaggio hanno lo stesso valore, si considera una corrispondenza.</span><span class="sxs-lookup"><span data-stu-id="4fb95-130">If the property in the filter and the property on the message have the same value, it is considered a match.</span></span>

<span data-ttu-id="4fb95-131">Per il filtro StoreId, *sarebbe possibile* usare un filtro SQL.</span><span class="sxs-lookup"><span data-stu-id="4fb95-131">For our StoreId filter, we *could* use a SQL filter.</span></span> <span data-ttu-id="4fb95-132">Questi filtri sono i più flessibili, ma anche i più impegnativi dal punto di vista del calcolo e possono rallentare la velocità effettiva del bus di servizio.</span><span class="sxs-lookup"><span data-stu-id="4fb95-132">Those filters are the most flexible, but they're also the most computationally expensive and could slow down our Service Bus throughput.</span></span> <span data-ttu-id="4fb95-133">In questo caso è preferibile scegliere un filtro di correlazione.</span><span class="sxs-lookup"><span data-stu-id="4fb95-133">In this case, we choose a correlation filter instead.</span></span> 

## <a name="topicclient-example"></a><span data-ttu-id="4fb95-134">Esempio TopicClient</span><span class="sxs-lookup"><span data-stu-id="4fb95-134">TopicClient example</span></span>

<span data-ttu-id="4fb95-135">In qualsiasi componente di invio o di ricezione è necessario aggiungere le istruzioni `using` seguenti a qualsiasi file di codice che chiama un argomento del bus di servizio:</span><span class="sxs-lookup"><span data-stu-id="4fb95-135">In any sending or receiving component, you should add the following `using` statements to any code file that calls a Service Bus topic:</span></span>

```C#
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Azure.ServiceBus;
```

<span data-ttu-id="4fb95-136">Per inviare un messaggio, iniziare creando un nuovo oggetto `TopicClient` e passare la stringa di connessione e il nome dell'argomento:</span><span class="sxs-lookup"><span data-stu-id="4fb95-136">To send a message, start by creating a new `TopicClient` object and pass it the connection string and the name of the topic:</span></span>

```C#
topicClient = new TopicClient(TextAppConnectionString, "GroupMessageTopic");
```

<span data-ttu-id="4fb95-137">È possibile inviare un messaggio all'argomento, chiamando il metodo `TopicClient.SendAsync()` e passando il messaggio.</span><span class="sxs-lookup"><span data-stu-id="4fb95-137">You can send a message to the topic by calling the `TopicClient.SendAsync()` method and passing the message.</span></span> <span data-ttu-id="4fb95-138">Come nel caso delle code, il messaggio deve essere in formato di stringa con codifica UTF8:</span><span class="sxs-lookup"><span data-stu-id="4fb95-138">As with queues, the message must be in the form of a UTF-8 encoded string:</span></span>

```C#
string message = "Cancel! I can't believe you use canned mushrooms!";
var encodedMessage = new Message(Encoding.UTF8.GetBytes(message));
await topicClient.SendAsync(encodedMessage);
```

<span data-ttu-id="4fb95-139">Per ricevere messaggi, è necessario creare un oggetto `SubscriptionClient` e non un oggetto `TopicClient` e passare la stringa di connessione, il nome dell'argomento **e** il nome della sottoscrizione:</span><span class="sxs-lookup"><span data-stu-id="4fb95-139">To receive messages, you must create a `SubscriptionClient` object, not a `TopicClient` object, and pass it the connection string, the name of the topic, **and** the name of the subscription:</span></span>

```C#
subscriptionClient = new SubscriptionClient(ServiceBusConnectionString, "GroupMessageTopic", "NorthAmerica");
```

<span data-ttu-id="4fb95-140">Registrare quindi un gestore di messaggi, ovvero il metodo asincrono nel codice che elabora il messaggio recuperato.</span><span class="sxs-lookup"><span data-stu-id="4fb95-140">Then register a message handler - this is the asynchronous method in your code that processes the retrieved message.</span></span>

```C#
subscriptionClient.RegisterMessageHandler(MessageHandler, messageHandlerOptions);
```

<span data-ttu-id="4fb95-141">Nel gestore di messaggi chiamare il metodo `SubscriptionClient.CompleteAsync()` per rimuovere il messaggio dalla coda:</span><span class="sxs-lookup"><span data-stu-id="4fb95-141">Within the message handler, call the `SubscriptionClient.CompleteAsync()` method to remove the message from the queue:</span></span>

```C#
await subscriptionClient.CompleteAsync(message.SystemProperties.LockToken);
```