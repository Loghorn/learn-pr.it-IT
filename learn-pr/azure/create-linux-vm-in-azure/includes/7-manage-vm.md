<span data-ttu-id="d44eb-101">Apportare modifiche alla configurazione del server è un'operazione eseguita comunemente con dispositivi nell'ambiente locale.</span><span class="sxs-lookup"><span data-stu-id="d44eb-101">Making adjustments to server configuration is commonly performed with equipment in your on-premises environment.</span></span> <span data-ttu-id="d44eb-102">In questo senso, è possibile considerare le macchine virtuali di Azure un'estensione di tale ambiente.</span><span class="sxs-lookup"><span data-stu-id="d44eb-102">In this sense, you can consider Azure VMs to be an extension of that environment.</span></span> <span data-ttu-id="d44eb-103">È possibile alterare la configurazione, gestire le reti, aprire o bloccare il traffico e così via, tramite il portale di Azure, l'interfaccia della riga di comando di Azure o strumenti di Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="d44eb-103">You can alter configuration, manage networks, open or block traffic, and more through the Azure portal, Azure CLI, or Azure PowerShell tools.</span></span>

<span data-ttu-id="d44eb-104">A questo punto il server è in esecuzione, Apache è installato e serve le pagine.</span><span class="sxs-lookup"><span data-stu-id="d44eb-104">We've got our server running, and Apache is installed and serving up pages.</span></span> <span data-ttu-id="d44eb-105">Il team di sicurezza impone il blocco di tutti i server. Non è ancora stata eseguita alcuna operazione per questa macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="d44eb-105">Our security team mandates that we lock down all our servers - we've not done anything to this VM yet.</span></span> <span data-ttu-id="d44eb-106">Per questo, Apache è in ascolto sulla porta 80.</span><span class="sxs-lookup"><span data-stu-id="d44eb-106">We didn't do anything, and it let Apache listen on port 80.</span></span> <span data-ttu-id="d44eb-107">Si esaminerà ora la configurazione di rete di Azure per scoprire come usare il supporto della sicurezza predefinito per migliorare la protezione del server.</span><span class="sxs-lookup"><span data-stu-id="d44eb-107">Let's explore the Azure network configuration to see how to use the built-in security support to harden our server.</span></span>

## <a name="opening-ports-in-azure-vms"></a><span data-ttu-id="d44eb-108">Apertura delle porte nelle macchine virtuali di Azure</span><span class="sxs-lookup"><span data-stu-id="d44eb-108">Opening ports in Azure VMs</span></span>

<!-- TODO: Azure portal is inconsistent here in applying the NSG.
By default, new VMs are locked down. 

Apps can make outgoing requests, but the only inbound traffic allowed is from the virtual network (e.g., other resources on the same local network), and from Azure's Load Balancer (probe checks). -->

<span data-ttu-id="d44eb-109">Esistono due passaggi per modificare la configurazione per supportare protocolli diversi nella rete.</span><span class="sxs-lookup"><span data-stu-id="d44eb-109">There are two steps to adjusting the configuration to support different protocols on the network.</span></span> <span data-ttu-id="d44eb-110">Quando si crea una nuova macchina virtuale, è possibile aprire alcune porte comuni (RDP, HTTP, HTTPS e SSH).</span><span class="sxs-lookup"><span data-stu-id="d44eb-110">When you create a new VM, you have an opportunity to open a few common ports (RDP, HTTP, HTTPS, and SSH).</span></span> <span data-ttu-id="d44eb-111">Tuttavia, se sono necessarie altre modifiche al firewall, sarà necessario intervenire manualmente.</span><span class="sxs-lookup"><span data-stu-id="d44eb-111">However, if you require other changes to the firewall, you will need to adjust them manually.</span></span>

<span data-ttu-id="d44eb-112">La procedura prevede due passaggi:</span><span class="sxs-lookup"><span data-stu-id="d44eb-112">The process for this involves two steps:</span></span>

1. <span data-ttu-id="d44eb-113">Creare un gruppo di sicurezza di rete.</span><span class="sxs-lookup"><span data-stu-id="d44eb-113">Create a Network Security Group.</span></span>
2. <span data-ttu-id="d44eb-114">Creare una regola in ingresso che consenta il traffico sulle porte necessarie.</span><span class="sxs-lookup"><span data-stu-id="d44eb-114">Create an inbound rule allowing traffic on the ports you need.</span></span>

### <a name="what-is-a-network-security-group"></a><span data-ttu-id="d44eb-115">Che cos'è un gruppo di sicurezza di rete?</span><span class="sxs-lookup"><span data-stu-id="d44eb-115">What is a Network Security Group?</span></span>

<span data-ttu-id="d44eb-116">Le reti virtuali sono alla base del modello di rete di Azure e offrono isolamento e protezione.</span><span class="sxs-lookup"><span data-stu-id="d44eb-116">Virtual networks (VNets) are the foundation of the Azure networking model and provide isolation and protection.</span></span> <span data-ttu-id="d44eb-117">I gruppi di sicurezza di rete (NSG) sono lo strumento principale che consente di applicare e controllare le regole del traffico di rete a livello di rete.</span><span class="sxs-lookup"><span data-stu-id="d44eb-117">Network Security Groups (NSGs) are the primary tool you use to enforce and control network traffic rules at the networking level.</span></span> <span data-ttu-id="d44eb-118">I gruppi di sicurezza di rete sono un livello di sicurezza facoltativo che fornisce un firewall software mediante il filtraggio del traffico in ingresso e in uscita sulla rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="d44eb-118">NSGs are an optional security layer that provides a software firewall by filtering inbound and outbound traffic on the VNet.</span></span> 

<span data-ttu-id="d44eb-119">I gruppi di sicurezza possono essere associati a un'interfaccia di rete (per le regole per ogni host), a una subnet nella rete virtuale (per l'applicazione a più risorse) o a entrambi i livelli.</span><span class="sxs-lookup"><span data-stu-id="d44eb-119">Security groups can be associated to a network interface (for per-host rules), a subnet in the virtual network (to apply to multiple resources), or both levels.</span></span> 

#### <a name="security-group-rules"></a><span data-ttu-id="d44eb-120">Regole dei gruppi di sicurezza</span><span class="sxs-lookup"><span data-stu-id="d44eb-120">Security group rules</span></span>

<span data-ttu-id="d44eb-121">I gruppi di sicurezza di rete usano _regole_ per consentire o negare il transito del traffico nella rete.</span><span class="sxs-lookup"><span data-stu-id="d44eb-121">NGSs use _rules_ to allow or deny traffic moving through the network.</span></span> <span data-ttu-id="d44eb-122">Ogni regola identifica l'indirizzo di origine e destinazione (o un intervallo), il protocollo, la porta (o intervallo di porte), la direzione (in ingresso o in uscita), una priorità numerica e se consentire o negare il traffico che corrisponde alla regola.</span><span class="sxs-lookup"><span data-stu-id="d44eb-122">Each rule identifies the source and destination address (or range), protocol, port (or range), direction (inbound or outbound), a numeric priority, and whether to allow or deny the traffic that matches the rule.</span></span>

![Regole dei gruppi di sicurezza di rete](../media/7-nsg-rules.png)

<span data-ttu-id="d44eb-124">Ogni gruppo di sicurezza ha un set di regole di sicurezza predefinite per applicare le regole di rete predefinite descritte in precedenza.</span><span class="sxs-lookup"><span data-stu-id="d44eb-124">Each security group has a set of default security rules to apply the default network rules described above.</span></span> <span data-ttu-id="d44eb-125">Queste regole predefinite non possono essere modificate, ma _possono_ essere sottoposto a override.</span><span class="sxs-lookup"><span data-stu-id="d44eb-125">These default rules cannot be modified, but _can_ be overridden.</span></span>

#### <a name="how-azure-uses-network-rules"></a><span data-ttu-id="d44eb-126">Come vengono usate le regole di rete in Azure</span><span class="sxs-lookup"><span data-stu-id="d44eb-126">How Azure uses network rules</span></span>

<span data-ttu-id="d44eb-127">Per il traffico in ingresso, Azure elabora il gruppo di sicurezza associato alla subnet e quindi il gruppo di sicurezza applicato all'interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="d44eb-127">For inbound traffic, Azure processes the security group associated to the subnet, and then the security group applied to the network interface.</span></span> <span data-ttu-id="d44eb-128">Il traffico in uscita viene gestito nell'ordine inverso, vale a dire prima l'interfaccia di rete seguita dalla subnet.</span><span class="sxs-lookup"><span data-stu-id="d44eb-128">Outbound traffic is handled in the opposite order (the network interface first, followed by the subnet).</span></span>

> [!WARNING]
> <span data-ttu-id="d44eb-129">Tenere presente che i gruppi di sicurezza sono facoltativi a entrambi i livelli.</span><span class="sxs-lookup"><span data-stu-id="d44eb-129">Keep in mind that security groups are optional at both levels.</span></span> <span data-ttu-id="d44eb-130">Se non viene applicato alcun gruppo di sicurezza, **tutto il traffico è consentito** da Azure.</span><span class="sxs-lookup"><span data-stu-id="d44eb-130">If no security group is applied then **all traffic is allowed** by Azure.</span></span> <span data-ttu-id="d44eb-131">Se la macchina virtuale ha un indirizzo IP pubblico, questo potrebbe essere un grave rischio in particolare se il sistema operativo non include un firewall incorporato.</span><span class="sxs-lookup"><span data-stu-id="d44eb-131">If the VM has a public IP, this could be a serious risk particularly if the OS doesn't provide a built-in firewall.</span></span>

<span data-ttu-id="d44eb-132">Le regole vengono valutate nell'_ordine di priorità_, a partire dalla regola con la **priorità più bassa**.</span><span class="sxs-lookup"><span data-stu-id="d44eb-132">The rules are evaluated in _priority-order_, starting with the **lowest priority** rule.</span></span> <span data-ttu-id="d44eb-133">Le regole di negazione **arrestano** sempre la valutazione.</span><span class="sxs-lookup"><span data-stu-id="d44eb-133">Deny rules always **stop** the evaluation.</span></span> <span data-ttu-id="d44eb-134">Ad esempio, se una regola di interfaccia di rete blocca una richiesta in uscita, tutte le regole applicate alla subnet non verranno controllate.</span><span class="sxs-lookup"><span data-stu-id="d44eb-134">For example, if a network interface rule blocks an outbound request, any rules applied to the subnet will not be checked.</span></span> <span data-ttu-id="d44eb-135">Il traffico attraverso il gruppo di sicurezza viene consentito se passa attraverso _tutti_ i gruppi applicati.</span><span class="sxs-lookup"><span data-stu-id="d44eb-135">For traffic to be allowed through the security group, it must pass through _all_ applied groups.</span></span>

<span data-ttu-id="d44eb-136">L'ultima regola è sempre una regola **Nega tutto**.</span><span class="sxs-lookup"><span data-stu-id="d44eb-136">The last rule is always a **Deny All** rule.</span></span> <span data-ttu-id="d44eb-137">Si tratta di una regola predefinita aggiunta a ogni gruppo di sicurezza per il traffico in ingresso e in uscita con una priorità di 65500.</span><span class="sxs-lookup"><span data-stu-id="d44eb-137">This is a default rule added to every security group for both inbound and outbound traffic with a priority of 65500.</span></span> <span data-ttu-id="d44eb-138">Questo significa che affinché il traffico possa passare attraverso il gruppo di sicurezza _è necessario avere una regola per consentirlo_ oppure verrà bloccato dalla regola finale.</span><span class="sxs-lookup"><span data-stu-id="d44eb-138">That means to have traffic pass through the security group _you must have an allow rule_ or the final default rule will block it.</span></span>

> [!NOTE]
> <span data-ttu-id="d44eb-139">SMTP (porta 25) è un caso speciale. A seconda del livello di sottoscrizione e di quando è stato creato l'account, il traffico SMTP in uscita potrebbe essere bloccato.</span><span class="sxs-lookup"><span data-stu-id="d44eb-139">SMTP (port 25) is a special case, depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked.</span></span> <span data-ttu-id="d44eb-140">È possibile richiedere di rimuovere questa restrizione con una giustificazione aziendale.</span><span class="sxs-lookup"><span data-stu-id="d44eb-140">You can request to remove this restriction with business justification.</span></span>

<span data-ttu-id="d44eb-141">Dato che non è stato creato un gruppo di sicurezza per questa macchina virtuale, è possibile farlo e applicarlo.</span><span class="sxs-lookup"><span data-stu-id="d44eb-141">Since we didn't create a security group for this VM, let's do that and apply it.</span></span>

## <a name="creating-network-security-groups"></a><span data-ttu-id="d44eb-142">Creazione di gruppi di sicurezza di rete</span><span class="sxs-lookup"><span data-stu-id="d44eb-142">Creating Network Security Groups</span></span>

<span data-ttu-id="d44eb-143">I gruppi di sicurezza sono risorse gestite, come la maggior parte degli elementi in Azure. È possibile crearli nel portale di Azure o tramite gli strumenti di scripting da riga di comando.</span><span class="sxs-lookup"><span data-stu-id="d44eb-143">Security groups are managed resources like most everything in Azure; you can create them in the Azure portal or through command-line scripting tools.</span></span> <span data-ttu-id="d44eb-144">L'aspetto più complicato è la definizione delle regole.</span><span class="sxs-lookup"><span data-stu-id="d44eb-144">The challenge is in defining the rules.</span></span> <span data-ttu-id="d44eb-145">Si vedrà come definire una nuova regola per consentire l'accesso HTTP e bloccare tutto il resto.</span><span class="sxs-lookup"><span data-stu-id="d44eb-145">Let's look at defining a new rule to allow HTTP access and block everything else.</span></span>